---
title: "【開発裏話】VS CodeからWordPressへ投稿するCLIツールの仕様設計と技術的ハマりどころ"
slug: "zidooka-cli-design-process"
status: "publish"
categories: 
  - "Programming"
  - "WordPress"
tags: 
  - "Node.js"
  - "CLI"
  - "System Design"
  - "Troubleshooting"
---

# 「ZIDOOKA CLI」はどうやって作られたのか？

こんにちは、ZIDOOKA! です。
先日公開した記事 **[【自作ツール公開】VS CodeからWordPressへ爆速投稿するCLIを作ってみた](https://www.zidooka.com/archives/1295)** はご覧いただけましたでしょうか？

今回は、このツールを開発するにあたっての **仕様設計のこだわり** や、**技術的に詰まったポイント（特に403エラー）**、そして **「アイキャッチ画像の自動設定」** などの細かいUX改善について、技術的な裏側を語りたいと思います。

将来的にコードを公開する可能性もあるので、その予告編としてお読みください。

![Gutenbergブロックとして認識されている様子](../images/2025/cli-demo-2.png)

## 1. なぜ「REST API」×「CLI」なのか？

最初は「VS Codeの拡張機能」も検討しましたが、以下の理由から **Node.js製のCLIツール** という形に落ち着きました。

*   **依存関係を減らしたい**: 拡張機能はメンテナンスが大変。
*   **自動化のしやすさ**: CLIなら、将来的にGitHub Actionsなどで「Pushしたら投稿」というフローも組める。
*   **ローカル完結**: 画像ファイルを手元で管理し、Markdownの相対パスで参照できる体験を重視したかった。

## 2. こだわりの「Gutenbergブロック変換」

単にMarkdownをHTMLに変換して `content` に突っ込むだけだと、WordPress側では **「クラシックブロック」** や **「カスタムHTML」** として扱われてしまいます。これだと、後からスマホで編集したい時などに非常に不便です。

そこで、Markdownパーサー（`marked`）のトークンを解析し、**WordPressのブロック形式（HTMLコメント記法）** に変換する処理を実装しました。

```javascript
// 変換イメージ
// Markdown: # 見出し
// ↓
// WP Block: <!-- wp:heading --><h2>見出し</h2><!-- /wp:heading -->
```

特に画像ブロックは、単なる `<img>` タグではなく、**WordPressのメディアID** と紐付ける必要があります。
そのため、**「画像をアップロード → IDを取得 → そのIDを使って画像ブロックのHTMLを生成」** というフローを組んでいます。

## 3. 最大の壁：403 Forbidden との戦い

開発中、最も時間を溶かしたのが **「WAFを無効にしても403エラーが出る」** 問題です。
特に英語の記事や、コードブロックを多く含む記事を投稿しようとすると、サーバー（Lolipop）側で弾かれてしまいました。

### 解決策：2段階投稿戦略

調査の結果、いきなり長文のデータをPOSTするとスパム判定される可能性が高いことがわかりました。
そこで、以下の **「2段階投稿」** を実装しました。

1.  まず、タイトルだけの **「空の下書き」** を作成する（これは軽いので通る）。
2.  返ってきた記事IDに対して、**「中身（content）」をUpdate** する。

この仕様変更により、SiteGuardやサーバー側のセキュリティフィルターを回避して安定して投稿できるようになりました。

## 4. 地味に便利な「アイキャッチ自動設定」

ブログを書く上で一番面倒なのが **「アイキャッチ画像の設定」** です。
記事内に画像があるのに、わざわざ別の枠に同じ画像を設定するのは二度手間ですよね。

そこで、以下のロジックを組み込みました。

1.  Frontmatter（記事冒頭の設定）で `featured_image` が指定されていれば、それを使う。
2.  **指定がない場合、記事内で最初にアップロードに成功した画像を自動的にアイキャッチとして登録する。**

これにより、「とりあえず記事内に画像を貼っておけば、勝手に見栄えの良い記事になる」という体験を実現しました。

## まとめ

「自分専用のツール」だからこそ、自分の執筆スタイルに完全にフィットした仕様にできるのが自作の強みです。
コードのリファクタリングが済んだら、GitHubで公開するかもしれません。

もし興味がある方は、ぜひX（Twitter）などで反応をいただけると嬉しいです！
